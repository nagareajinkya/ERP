version: '3.8'

services:
  # 1. Databases
  db-auth:
    image: postgres:15-alpine
    environment:
      POSTGRES_DB: sbms_db
      POSTGRES_USER: ${DB_USERNAME:-postgres}
      POSTGRES_PASSWORD: ${DB_PASSWORD:-manager}
    volumes:
      - auth_db_data:/var/lib/postgresql/data
    networks:
      - sbms-network

  db-trading:
    image: postgres:15-alpine
    environment:
      POSTGRES_DB: trading_db
      POSTGRES_USER: ${DB_USERNAME:-postgres}
      POSTGRES_PASSWORD: ${DB_PASSWORD:-manager}
    volumes:
      - trading_db_data:/var/lib/postgresql/data
    networks:
      - sbms-network

  db-parties:
    image: postgres:15-alpine
    environment:
      POSTGRES_DB: trading_db
      POSTGRES_USER: ${DB_USERNAME:-postgres}
      POSTGRES_PASSWORD: ${DB_PASSWORD:-manager}
    volumes:
      - parties_db_data:/var/lib/postgresql/data
    networks:
      - sbms-network

  db-smartops:
    image: mongo:6.0
    volumes:
      - smartops_db_data:/data/db
    networks:
      - sbms-network

  # 2. Main Services
  auth-service:
    build: ./service-auth
    image: ${DOCKER_HUB_USERNAME}/auth-service:latest
    environment:
      - DB_URL=jdbc:postgresql://db-auth:5432/sbms_db
      - DB_USERNAME=${DB_USERNAME:-postgres}
      - DB_PASSWORD=${DB_PASSWORD:-manager}
      - JWT_SECRET=${JWT_SECRET}
      - AWS_ACCESS_KEY=${AWS_ACCESS_KEY}
      - AWS_SECRET_KEY=${AWS_SECRET_KEY}
      - DDL_AUTO=update
    depends_on:
      - db-auth
    networks:
      - sbms-network

  trading-service:
    build: ./service-trading
    image: ${DOCKER_HUB_USERNAME}/trading-service:latest
    environment:
      - DB_URL=jdbc:postgresql://db-trading:5432/trading_db
      - DB_USERNAME=${DB_USERNAME:-postgres}
      - DB_PASSWORD=${DB_PASSWORD:-manager}
      - JWT_SECRET=${JWT_SECRET}
      - DDL_AUTO=update
      - SERVICE_PARTIES_URL=http://parties-service:5000
      - SERVICE_SMARTOPS_URL=http://smart-ops-service:5002
    depends_on:
      - db-trading
    networks:
      - sbms-network

  parties-service:
    build: ./service-parties
    image: ${DOCKER_HUB_USERNAME}/parties-service:latest
    environment:
      - DB_HOST=db-parties
      - DB_PORT=5432
      - DB_NAME=trading_db
      - DB_USERNAME=${DB_USERNAME:-postgres}
      - DB_PASSWORD=${DB_PASSWORD:-manager}
      - JWT_SECRET=${JWT_SECRET}
    depends_on:
      - db-parties
    networks:
      - sbms-network

  smart-ops-service:
    build: ./service-smart-ops
    image: ${DOCKER_HUB_USERNAME}/smart-ops-service:latest
    environment:
      - JWT_SECRET=${JWT_SECRET}
      - MONGODB_URI=mongodb://db-smartops:27017/smart_ops_db
    depends_on:
      - db-smartops
    networks:
      - sbms-network

  # 3. API Gateway
  api-gateway:
    build: ./api-gateway
    image: ${DOCKER_HUB_USERNAME}/api-gateway:latest
    # Removed ports block. Gateway is now secured inside the Docker network.
    environment:
      - ALLOWED_ORIGINS=${ALLOWED_ORIGINS:-*}
      - AUTH_SERVICE_URL=http://auth-service:8081
      - TRADING_SERVICE_URL=http://trading-service:8082
      - PARTIES_SERVICE_URL=http://parties-service:5000
      - SMARTOPS_SERVICE_URL=http://smart-ops-service:5002
    depends_on:
      - auth-service
      - trading-service
      - parties-service
      - smart-ops-service
    networks:
      - sbms-network

  # 4. Frontend 
  frontend:
    build: ./client
    image: ${DOCKER_HUB_USERNAME}/frontend:latest
    depends_on:
      - api-gateway
    networks:
      - sbms-network

  # 5. Nginx Reverse Proxy (HTTPS/SSL Termination)
  nginx-proxy:
    image: nginx:alpine
    ports:
      - "80:80"      
      - "443:443"    
    volumes:
      - ./nginx/conf.d:/etc/nginx/conf.d:ro
      - ./certbot/conf:/etc/letsencrypt:ro
      - ./certbot/www:/var/www/certbot:ro
    # Removed depends_on: frontend to allow SSL script to run independently
    networks:
      - sbms-network
    restart: unless-stopped

  # 6. Certbot (SSL Certificate Management)
  certbot:
    image: certbot/certbot
    volumes:
      - ./certbot/conf:/etc/letsencrypt
      - ./certbot/www:/var/www/certbot
    entrypoint: "/bin/sh -c 'trap exit TERM; while :; do certbot renew; sleep 12h & wait $${!}; done;'"
    networks:
      - sbms-network

networks:
  sbms-network:
    driver: bridge

volumes:
  auth_db_data:
  trading_db_data:
  parties_db_data:
  smartops_db_data: